package main

import (
	"context"
	"io"
	"log"
	"time"

	"google.golang.org/grpc"
	"google.golang.org/grpc/credentials/insecure" // –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

	// –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û–¢ –ü–£–¢–¨ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –ø—É—Ç—å –≤–∞—à–µ–≥–æ –º–æ–¥—É–ª—è, –Ω–∞–ø—Ä–∏–º–µ—Ä: "github.com/user/grpc-sub-example/subscription"
	pb "tetstststs/subscription"
)

const (
	address = "localhost:50051"
)

func main() {
	// --- 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º grpc.NewClient (–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ–¥—Ö–æ–¥) ---

	// –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è RPC.
	ctx, cancel := context.WithTimeout(context.Background(), time.Second*10)
	defer cancel()

	log.Printf("–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ gRPC-—Å–µ—Ä–≤–µ—Ä—É –Ω–∞ %s (–∏—Å–ø–æ–ª—å–∑—É—è NewClient)...", address)

	// 1. –°–æ–∑–¥–∞–Ω–∏–µ ClientConn Builder
	ccb, err := grpc.NewClient(address)

	// 2. –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ (–Ω–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ) —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
	ccb = ccb.WithTransportCredentials(insecure.NewCredentials())

	// –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–∞–π–º–∞—É—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)
	// ccb = ccb.WithBlock() // –î–µ–ª–∞–µ—Ç –≤—ã–∑–æ–≤ Build –±–ª–æ–∫–∏—Ä—É—é—â–∏–º
	// ccb = ccb.WithContext(ctx) // –ü–µ—Ä–µ–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

	// 3. –°—Ç—Ä–æ–∏–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ. –í—ã–∑–æ–≤ Build –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.
	// –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–º–µ–µ—Ç —Ç–∞–π–º–∞—É—Ç, –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–µ–Ω–æ –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏.
	conn, err := ccb.Build(ctx)
	if err != nil {
		log.Fatalf("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º: %v", err)
	}
	defer conn.Close() // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏ main

	// --- 2. –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –∑–∞–ø—Ä–æ—Å–∞ ---

	c := pb.NewSubscriptionServiceClient(conn)

	request := &pb.SubscribeRequest{
		Topic: "market_data_feed",
	}

	// --- 3. –í—ã–∑–æ–≤ Server Streaming RPC ---

	log.Printf("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ —Ç–µ–º—É '%s'...", request.GetTopic())

	// Server Streaming RPC –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Ç–æ–∫ (stream)
	stream, err := c.Subscribe(ctx, request)
	if err != nil {
		log.Fatalf("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–∑–≤–∞—Ç—å Subscribe: %v", err)
	}

	log.Println("--- –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ª—É—á–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ---")

	// --- 4. –ß—Ç–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ü–∏–∫–ª–µ ---
	for {
		// –ß–∏—Ç–∞–µ–º —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –ø–æ—Ç–æ–∫–∞
		res, err := stream.Recv()

		// io.EOF (End of File) - –æ–∂–∏–¥–∞–µ–º—ã–π —Å–∏–≥–Ω–∞–ª, –∫–æ–≥–¥–∞ —Å–µ—Ä–≤–µ—Ä –∑–∞–≤–µ—Ä—à–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É.
		if err == io.EOF {
			log.Println("üèÅ –°–µ—Ä–≤–µ—Ä –∑–∞–≤–µ—Ä—à–∏–ª –ø–æ—Ç–æ–∫. –ü–æ–¥–ø–∏—Å–∫–∞ –æ–∫–æ–Ω—á–µ–Ω–∞.")
			break
		}

		// –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Ç–µ—Ä—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)
		if err != nil {
			log.Fatalf("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –ø–æ—Ç–æ–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: %v", err)
		}

		// –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
		log.Printf("‚û°Ô∏è [–û–ë–ù–û–í–õ–ï–ù–ò–ï #%d] %s", res.GetCount(), res.GetMessage())
	}

	log.Println("--- –ö–ª–∏–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É ---")
}
