# Интеграционные тест-кейсы MiniToolStream

**Дата:** 17 декабря 2025
**Общее количество тест-кейсов:** 20
**Статус:** Все тесты пройдены успешно (100%)

---

## 1. Тесты JWT аутентификации и авторизации (6 тест-кейсов)

### 1.1. JWT Validation (4 тест-кейса)

#### TC-AUTH-001: Валидный JWT токен
**Цель:** Проверка успешной аутентификации с валидным JWT токеном

**Предусловия:**
- JWT авторизация включена на сервере
- Существуют валидные RSA ключи в Vault

**Шаги:**
1. Сгенерировать валидный JWT токен с permissions: `publish`, `subscribe`, `fetch`
2. Установить allowed subjects: `test.*`
3. Отправить Publish запрос с токеном в Authorization header
4. Проверить успешность публикации

**Ожидаемый результат:**
- Запрос принят
- Сообщение опубликовано
- Получен sequence number
- Статус код: 0 (успех)

**Результат:** ✅ PASS

---

#### TC-AUTH-002: JWT токен с невалидной подписью
**Цель:** Проверка отклонения токена с неправильной подписью

**Предусловия:**
- JWT авторизация включена на сервере

**Шаги:**
1. Создать JWT токен
2. Изменить подпись токена на невалидную
3. Отправить Publish запрос с испорченным токеном
4. Проверить отклонение запроса

**Ожидаемый результат:**
- Запрос отклонен
- gRPC код ошибки: `Unauthenticated`
- Сообщение об ошибке содержит информацию о невалидной подписи

**Результат:** ✅ PASS

---

#### TC-AUTH-003: Истекший JWT токен
**Цель:** Проверка отклонения токена с истекшим сроком действия

**Предусловия:**
- JWT авторизация включена на сервере

**Шаги:**
1. Сгенерировать JWT токен с ExpiresAt в прошлом (время истечения: -1 час)
2. Отправить Publish запрос с истекшим токеном
3. Проверить отклонение запроса

**Ожидаемый результат:**
- Запрос отклонен
- gRPC код ошибки: `Unauthenticated`
- Сообщение об ошибке: "token expired"

**Результат:** ✅ PASS

---

#### TC-AUTH-004: Запрос без JWT токена
**Цель:** Проверка поведения при отсутствии токена (optional authentication)

**Предусловия:**
- JWT авторизация включена с `require_auth: false`

**Шаги:**
1. Отправить Publish запрос без Authorization header
2. Проверить обработку запроса

**Ожидаемый результат:**
- Запрос принят (авторизация опциональна)
- Сообщение опубликовано
- Получен sequence number

**Примечание:** При `require_auth: true` запрос должен быть отклонен

**Результат:** ✅ PASS

---

### 1.2. Permission Control (2 тест-кейса)

#### TC-PERM-001: Отсутствие permission "publish"
**Цель:** Проверка отклонения публикации без соответствующего права

**Предусловия:**
- JWT авторизация включена на сервере

**Шаги:**
1. Сгенерировать JWT токен с permissions: `subscribe`, `fetch` (без `publish`)
2. Отправить Publish запрос с этим токеном
3. Проверить отклонение запроса

**Ожидаемый результат:**
- Запрос отклонен
- gRPC код ошибки: `PermissionDenied`
- Сообщение: "publish permission denied"

**Результат:** ✅ PASS

---

#### TC-PERM-002: Доступ к запрещенному subject
**Цель:** Проверка wildcard фильтрации subjects

**Предусловия:**
- JWT авторизация включена на сервере

**Шаги:**
1. Сгенерировать JWT токен с allowed_subjects: `allowed.*`
2. Попытаться опубликовать сообщение в subject: `forbidden.topic`
3. Попытаться опубликовать сообщение в subject: `allowed.topic`

**Ожидаемый результат:**
- Запрос к `forbidden.topic` отклонен с кодом `PermissionDenied`
- Запрос к `allowed.topic` принят и обработан успешно

**Результат:** ✅ PASS

---

## 2. Тесты обработки ошибок подключения (2 тест-кейса)

#### TC-CONN-001: Подключение к несуществующему серверу
**Цель:** Проверка корректной обработки недоступного сервера

**Шаги:**
1. Попытаться подключиться к адресу: `localhost:9999` (несуществующий порт)
2. Установить таймаут: 2 секунды
3. Проверить обработку ошибки

**Ожидаемый результат:**
- Подключение не установлено
- Ошибка: "context deadline exceeded"
- Время ожидания: ~2 секунды

**Результат:** ✅ PASS

---

#### TC-CONN-002: Таймаут подключения
**Цель:** Проверка обработки таймаута при подключении

**Шаги:**
1. Создать контекст с таймаутом 100ms
2. Попытаться подключиться к неотвечающему адресу
3. Проверить срабатывание таймаута

**Ожидаемый результат:**
- Подключение прервано по таймауту
- Ошибка: "context deadline exceeded"
- Время ожидания: ~100ms

**Результат:** ✅ PASS

---

## 3. Тесты валидации запросов (3 тест-кейса)

#### TC-REQ-001: Публикация с пустым subject
**Цель:** Проверка валидации обязательного поля subject

**Шаги:**
1. Создать PublishRequest с пустым subject: `""`
2. Заполнить поле data: `[]byte("test")`
3. Отправить запрос на сервер
4. Проверить отклонение запроса

**Ожидаемый результат:**
- Запрос обработан сервером
- StatusCode: 1 (ошибка)
- ErrorMessage: "subject cannot be empty"
- Sequence: 0

**Результат:** ✅ PASS

---

#### TC-REQ-002: Nil request (gRPC behavior)
**Цель:** Проверка обработки nil запроса

**Примечание:** В gRPC клиенте Go `nil` автоматически преобразуется в пустой protobuf message

**Шаги:**
1. Отправить: `client.Publish(ctx, nil)`
2. gRPC клиент конвертирует nil → пустой message
3. Сервер получает пустой message с пустым subject
4. Проверить отклонение

**Ожидаемый результат:**
- Запрос преобразован в пустой message
- StatusCode: 1 (ошибка)
- ErrorMessage: "subject cannot be empty"

**Результат:** ✅ PASS

---

#### TC-REQ-003: Очень длинное имя subject
**Цель:** Проверка ограничения на длину subject

**Шаги:**
1. Создать subject длиной 1000 символов: `strings.Repeat("a", 1000)`
2. Отправить Publish запрос с длинным subject
3. Проверить отклонение на уровне MinIO

**Ожидаемый результат:**
- Запрос отклонен MinIO
- ErrorMessage: "Object name contains unsupported characters"
- StatusCode: 1

**Результат:** ✅ PASS

---

## 4. Тесты ошибок Egress сервиса (5 тест-кейсов)

#### TC-EGR-001: Subscribe с пустым subject
**Цель:** Проверка валидации subject в Subscribe запросе

**Шаги:**
1. Создать SubscribeRequest с пустым subject
2. Вызвать метод Subscribe
3. Попытаться получить уведомления из stream

**Ожидаемый результат:**
- Stream завершается с ошибкой
- Ошибка: "subject cannot be empty"
- gRPC код: `Unknown`

**Результат:** ✅ PASS

---

#### TC-EGR-002: Subscribe с пустым durable_name
**Цель:** Проверка валидации обязательного поля durable_name

**Шаги:**
1. Создать SubscribeRequest с subject: `"test.topic"`, durable_name: `""`
2. Вызвать метод Subscribe
3. Проверить отклонение запроса

**Ожидаемый результат:**
- Stream завершается с ошибкой
- Ошибка: "durable_name cannot be empty"
- gRPC код: `Unknown`

**Результат:** ✅ PASS

---

#### TC-EGR-003: Fetch с пустым subject
**Цель:** Проверка валидации subject в Fetch запросе

**Шаги:**
1. Создать SubscriptionConfig с пустым subject для Fetch
2. Вызвать метод Fetch
3. Проверить отклонение

**Ожидаемый результат:**
- Stream завершается с ошибкой
- Ошибка: "subject cannot be empty"

**Результат:** ✅ PASS

---

#### TC-EGR-004: GetLastSequence с пустым subject
**Цель:** Проверка валидации в GetLastSequence

**Шаги:**
1. Вызвать GetLastSequence с пустым subject
2. Проверить отклонение запроса

**Ожидаемый результат:**
- Запрос отклонен
- Ошибка: "subject cannot be empty"

**Результат:** ✅ PASS

---

#### TC-EGR-005: GetLastSequence для несуществующего subject
**Цель:** Проверка поведения при запросе несуществующего subject

**Шаги:**
1. Вызвать GetLastSequence для subject: `"nonexistent.topic"`
2. Проверить возвращаемое значение

**Ожидаемый результат:**
- Запрос обработан успешно
- last_sequence: 0 (корректное поведение для нового subject)
- Без ошибок

**Результат:** ✅ PASS

---

## 5. Тесты валидации данных (4 тест-кейса)

#### TC-DATA-001: Публикация с пустыми данными
**Цель:** Проверка поддержки headers-only сообщений

**Шаги:**
1. Создать PublishRequest:
   - subject: `"test.empty"`
   - data: `[]byte("")` (пустой массив)
   - headers: `{"content-type": "text/plain"}`
2. Отправить запрос
3. Проверить успешность

**Ожидаемый результат:**
- Запрос принят
- Сообщение опубликовано
- Получен sequence number
- Пустые данные допустимы (headers-only message)

**Результат:** ✅ PASS

---

#### TC-DATA-002: Публикация с nil данными
**Цель:** Проверка обработки nil как пустых данных

**Шаги:**
1. Создать PublishRequest:
   - subject: `"test.nil"`
   - data: `nil`
2. Отправить запрос

**Ожидаемый результат:**
- Запрос принят
- nil данные обработаны как пустые
- Сообщение опубликовано

**Результат:** ✅ PASS

---

#### TC-DATA-003: Публикация большого сообщения (10 MB)
**Цель:** Проверка поддержки больших сообщений

**Предусловия:**
- gRPC MaxRecvMsgSize: 1 GB
- gRPC MaxSendMsgSize: 1 GB

**Шаги:**
1. Создать массив данных размером 10 MB:
   ```go
   data := make([]byte, 10*1024*1024) // 10 MB
   for i := range data {
       data[i] = byte(i % 256)
   }
   ```
2. Создать PublishRequest с этими данными
3. Отправить запрос
4. Проверить успешность публикации

**Ожидаемый результат:**
- Запрос принят
- Данные успешно загружены в MinIO
- Получен sequence number и object name
- Размер: 10,485,760 байт

**Результат:** ✅ PASS

---

#### TC-DATA-004: Subject со специальными символами
**Цель:** Проверка поддержки различных символов в subject

**Шаги:**
1. Опубликовать сообщения со следующими subjects:
   - `test.subject-with-dash` (дефис)
   - `test.subject_with_underscore` (подчеркивание)
   - `test.subject.with.dots` (точки)
   - `test/subject/with/slashes` (слэши)
2. Проверить успешность каждой публикации

**Ожидаемый результат:**
- Все subjects приняты
- Все сообщения опубликованы
- Получены соответствующие sequence numbers

**Результат:** ✅ PASS

---

## Сводная статистика

| Категория | Количество тест-кейсов | Статус |
|-----------|------------------------|--------|
| **JWT аутентификация** | 4 | ✅ 4/4 |
| **Контроль доступа (permissions)** | 2 | ✅ 2/2 |
| **Ошибки подключения** | 2 | ✅ 2/2 |
| **Валидация запросов** | 3 | ✅ 3/3 |
| **Ошибки Egress сервиса** | 5 | ✅ 5/5 |
| **Валидация данных** | 4 | ✅ 4/4 |
| **ИТОГО** | **20** | **✅ 20/20 (100%)** |

---

## Покрываемые функциональные требования

### Безопасность
- ✅ JWT аутентификация (RS256)
- ✅ Валидация подписи токена
- ✅ Проверка срока действия токена
- ✅ Контроль прав доступа (permissions)
- ✅ Фильтрация доступа к subjects (wildcard patterns)

### Надежность
- ✅ Обработка недоступности сервера
- ✅ Обработка таймаутов подключения
- ✅ Валидация входных данных
- ✅ Корректные коды ошибок

### Производительность
- ✅ Поддержка больших сообщений (до 10 MB)
- ✅ Время выполнения тестов: ~2.5 секунды

### Функциональность
- ✅ Публикация сообщений (Ingress)
- ✅ Подписка на уведомления (Subscribe)
- ✅ Получение сообщений (Fetch)
- ✅ Получение последнего sequence (GetLastSequence)
- ✅ Headers-only сообщения
- ✅ Специальные символы в subjects

---

## Тестовое окружение

**Инфраструктура:**
- Tarantool 2.11 (база данных метаданных)
- MinIO (объектное хранилище S3-compatible)
- HashiCorp Vault (управление секретами, JWT ключи)
- Docker Compose (оркестрация)

**Сервисы:**
- MiniToolStream Ingress (gRPC, порт 50051)
- MiniToolStream Egress (gRPC, порт 50052)

**Язык и фреймворки:**
- Go 1.24
- gRPC + Protocol Buffers
- JWT (RS256)

---

**Автор:** Claude Code
**Дата:** 17.12.2025
**Статус:** Все тесты успешно пройдены
